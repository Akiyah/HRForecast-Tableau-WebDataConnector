<html>
<meta http-equiv="Cache-Control" content="no-store" />
<head>
<title>HRForecast Connector</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
<script src="https://public.tableau.com/javascripts/api/tableauwdc-1.1.0.js" type="text/javascript"></script>
<script type="text/javascript">

function parseCSV(csv) {
  var data = [];

  var lines = csv.split('\n');
  for (var j = 0; j < lines.length; j++) {
    var d = [];
    var words = lines[j].split(',');
    for (var i = 0; i < words.length; i++) {
      d.push(words[i]);
    }
    data.push(d);
  }

  return data;
}

function csvUrlFromViewUrl(viewUrl) {
  var r = viewUrl.match(/http:\/\/([^/]+)\/(view|view_complex)\/([^/]+)\/([^/]+)\/([^/]+)/i)
  if (!r) {
    return null;
  }

  var csvUrl = 'http://' + r[1] + '/' + r[2].replace('view', 'csv') + '/' + r[3] + '/' + r[4] + '/' + r[5];
  return csvUrl;
}

function update(data, columnHeadersName, columnHeadersType, tableData) {
  for (var i = 0; i < data[0].length; i++) {
    columnHeadersName[i] = data[0][i];
    columnHeadersType[i] = (i == 0 ? 'datetime' : 'int');
  }

  for (var j = 1; j < data.length; j++) {
    var d = {};
    for (var i = 0; i < data[j].length; i++) {
      d[columnHeadersName[i]] = data[j][i];
    }
    tableData.push(d);
  }
}

$(function() {
  var columnHeadersName = [];
  var columnHeadersType = [];
  var tableData = [];

  var myConnector = tableau.makeConnector();

  myConnector.getColumnHeaders = function() {
    tableau.headersCallback(columnHeadersName, columnHeadersType);
  };
   
  myConnector.getTableData = function(lastRecordToken) {
    tableau.dataCallback(tableData, tableData.length.toString(), false);
  };

  tableau.registerConnector(myConnector);

  $('#submit').click(function() {
    var viewUrl = $('#viewUrl').val();
    var url = csvUrlFromViewUrl(viewUrl);
    if (!url) {
      window.alert('Input HRForecast view url.');
      return;
    }

    $.ajax({
      type: "GET",
      url: url,
      success: function(csv) {
        var data = parseCSV(csv);
        update(data, columnHeadersName, columnHeadersType, tableData);

        tableau.connectionData = url;
        tableau.connectionName = viewUrl;
        tableau.submit();
      },
      error: function(xhr, ajaxOptions, thrownError) {
        tableau.log("connection error: " + xhr.responseText + "\n" + thrownError);
        tableau.abortWithError("error connecting");
      }
    });
  });
});

</script>
</head>
<body>

 Enter a URL: 
 <input type="text" id="viewUrl" size="50" value="" placeholder="http://localhost:5127/view/service_name/section_name/graph_name, and so on" />  
 <button type="button" id="submit">submit</button><br/>

</body>
</html>

